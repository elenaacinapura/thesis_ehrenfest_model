\chapter{The Ehrenfest Chain}
In the previous chapter we have introduced the mathematical formalism of Markov chains and have investigated in particular the condition of asymptotic equilibrium. In this chapter we will then apply this knowledge to study a specific problem, namely the \emph{Ehrenfest urn problem}. The Ehrenfest urn problem is a \emph{Gedankenesperiment} formulated in an attempt to study the statistical properties of a gas diffusing in a volume. We will first introduce the problem, and then see how it can be very naturally formalized by means of Markov chains.

\section{The Ehrenfest urn problem}
Consider a system of $N$ particles distributed in 2 boxes, which are going to be called \emph{box A} and \emph{box B}. Suppose that, a regular time intervals, you select a particle at random and a box at random, and you put the selected particle in the selected box. The number of particles in each box will change in time, and we are interested in properties of the system after a sufficiently long period of time - that is, at equilibrium.

The just illustrated situation consists in very few and simple rules, but is nevertheless very useful to describe real processes of diffusion. For instance, we can use it to model an experiment in which a gas is initially spread in a certain volume; suddenly a wall is removed, giving access to another equal portion of space, and particles start diffusing the in whole space available. We can, at least in principle, keep track of how many particles are still the first sector, and how many are instead in the other one. We might then be interested in asking ourselves questions such as: what is the probability that the particles will all come back together to the original portion of volume? How much time does the system spend on average in a given configuration with $k$ particles on one side and $N - k$ on the other? These are by no means trivial questions, and they are central in understanding a fundamental question that arises when dealing with thermodynamic processes: why is there in thermodynamics an "arrow of time" that is otherwise absent is the principles of newtonian mechanics?

If we rest on the assumption that we can treat diffusion problems by modeling them as a stochastic processes obeying some rules as those formulated by Ehrenfest, then we can find precise answers to the mentioned questions thanks to Markov chains.

\section{Formalization through Markov chains}
Let us now translate the Ehrenfest urn problem into the language of Markov Chains. 
First of all, notice that the state of the system can be completely described by giving the number of particles in one of the two boxes; let us chose box A. Let then $X_t$ represent the number of particles in box A at time $t$ -- clearly, the number of particles in box B is then given by $N - X_t$. $X_t$ can take values $0, 1, 2, \dots, N$, for a total of $N + 1$ possible states. So to summarize
\begin{equation}
    X_t \in \Space = \{ 0, 1, 2, \dots, N \}
\end{equation}
where
\begin{equation}
    X_t = j \quad \Leftrightarrow \quad \text{there are $j$ particles in box A at time $t$}
\end{equation}
We can now see that a sequence $\{X_t\}_{t\in \mathbb{N}}$ satisfies the Markov property, thus representing a Markov chain: this is true because the outcome of drawing one particle and a box at random does not depend on the previous drawings but only on the current distribution of particles in the boxes. If, for instance, there are $j$ particles in box A, the probability of drawing a particle that is in box A does not depend on the sequence that led to state $X_t = j$, but only on the state itself. Hence, the number of particles in box A at a given time only depends on the state of the time before, which is exactly the definition of the Markov property.

Let us calculate the transition probabilities explicitly. Suppose that there are $j$ particles in box A at time $t$, i.e. $X_t = j$. Then only three events can happen at time $t+1$: either the box has acquired one particle, or it lost acquired one, or it has the same number of particles as before. So, given $X_t = j$, $X_{t+1}$ can only equal $j+1$, $j-1$ or $j$. The probability that $X_{t+1} = j+1$ is given by the probability of drawing a particle from box B, which is $(N-j)/N$, times the probability of drawing box A, which is $1/2$. Similarly, the probability that $X_{t+1} = j - 1$ is given by the probability of drawing a particle from box A, which is $j/N$, times the probability of drawing box B, which is $1/2$. Lastly, the event that $X_t = j$ can happen either if one draws a particle from box A and box A, or if one draws a particle from box B and box B, for a total of $\frac{j}{2N} + \frac{N-j}{2N} = 1/2$. So, in summary
\begin{equation}
    P_{ij} = \prob{X_{t+1} = i | X_t = j} =
    \begin{cases}
        \frac{j}{2N} & \text{if $i = j - 1$} \\
        \frac{1}{2} & \text{if $i = j$}\\
        \frac{N - j}{2N} & \text{if $i = j + 1$} \\
        0 & \text{otherwise}
    \end{cases}
\end{equation}
Having calculated the transition probabilities, we can directly write the transition matrix. Notice that it will be a tridiagonal matrix, since a state $j$ only connects the states $j$, $j+1$ and $j-1$, and will have $1/2$ on the diagonal. The transition matrix will look like this:
\begin{equation} \label{eq:ehrenfest_P}
    P = 
    \begin{pmatrix}
        \half & \frac{1}{2N} & 0 &  &  &  &  &  &  &  &  \\
        \half & \half & \frac{2}{2N} & 0 &  &  &  &  & &  \\
        0  & \frac{N-1}{2N} & \half & \frac{3}{2N} & 0 & &  &  & \bigzero & &\\
         & 0 & \frac{N-2}{2N} & \half & \ddots & 0 &  & & & &\\
         &  & 0 & \frac{N-3}{2N} & \ddots & \ddots & 0 & & & &\\

         &  &  & 0 & \ddots & \ddots & \frac{j}{2N} & 0 & & & \\
         &  &  & &0 & \ddots & \half & \ddots  &0 & & \\
         &  &  & & &0 &  \frac{N-j}{2N} & \ddots & \ddots  & 0& \\
         
         & & \bigzero & & & &0  & \ddots & \ddots & \frac{N-1}{2N} & 0\\
         & & & & & & & 0 & \ddots & \half & \half \\
          & & & & & & & & 0& \frac{1}{2N} & \half
    \end{pmatrix}
\end{equation}
\section{The limiting properties of the Ehrenfest chain}
Let us now investigate the asymptotic behaviour of the Ehrenfest chain, and let us start by finding its stationary distribution.

\begin{theorem}
    Given an Ehrenfest chain on a system with $N$ particles, the components of its stationary distribution are given by
    \begin{equation} \label{eq:ehrenfest_staz}
        \pi_j = {{N} \choose {j}} \left(\half \right)^{N}
    \end{equation}
\end{theorem}
\begin{proof}
    Let us prove that $(P \p)_i =\pi_i$ for all $i$:

        \begin{align}
            (P \p)_i 
            & =  \sum_{j = 0}^N P_{ij} \pi_j \\
            & = P_{i,i+1}~\pi_{i+1} + P_{i,i}~\pi_i + P_{i,i-1}~\pi_{i-1} && \text{P is tridiagonal} \\
            & = \frac{N-(i-1)}{2N} {{N} \choose {i-1}} \left(\half \right)^{N} + \half {{N} \choose {i}} \left(\half \right)^{N} + \frac{i+1}{2N} {{N} \choose {i+1}} \left(\half \right)^{N} \\
            & \text{collecting $(1/2)^{N+1}$ and simplifying factorials} \\
            & = \left(\half \right)^{N+1} \left[ \frac{(N-1)!}{(i-1)! (N-i)!} + \frac{(N-1)!}{i! (N-i-1)!} + {{N} \choose {i}} \right]\\
            & = \left(\half \right)^{N+1} \left[ \frac{i (N-1)! + (N-1)! (N-i)}{i! (N-i)!} + {{N} \choose {i}} \right] \\
            & = \left(\half \right)^{N+1} \left[ \frac{N (N-1)!}{i! (N-i)!} + {{N} \choose {i}} \right] \\
            & = \left(\half \right)^{N+1} \cdot 2 {{N} \choose {i}}\\
            & = \left(\half \right)^{N} {{N} \choose {i}} = \pi_i 
        \end{align}
\end{proof}